<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Pharmaceutical Snippet Classifier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.05); opacity: 0.1; }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .algorithm-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .algorithm-info h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .algorithm-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
        }

        .main-content {
            padding: 40px;
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-button:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .batch-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .batch-upload-area:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.02);
        }

        .batch-textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95em;
            resize: vertical;
        }

        .batch-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .batch-process-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .batch-process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .batch-process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .snippet-separator-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .batch-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        .batch-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .batch-results-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 1em;
        }

        .batch-results-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .batch-results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .batch-results-table tr:hover {
            background-color: #e3f2fd;
        }

        .batch-snippet-cell {
            max-width: 400px;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.4;
            font-family: 'Consolas', 'Monaco', monospace;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 6px;
            padding: 10px;
        }

        .rationale-cell {
            max-width: 350px;
            font-size: 0.9em;
            line-height: 1.4;
            color: #555;
        }

        .table-tag-cell {
            min-width: 200px;
        }

        .batch-table-tag {
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            display: inline-block;
            margin: 2px;
        }

        .download-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: block;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .snippet-input {
            width: 100%;
            min-height: 180px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1em;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .snippet-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
            background: white;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            align-items: center;
        }

        .classify-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .classify-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .classify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .threshold-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .threshold-slider {
            width: 120px;
        }

        .processing-info {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .processing-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #3498db;
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: #27ae60;
            color: white;
        }

        .results-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 3px solid #e0e0e0;
        }

        .results-title {
            font-size: 1.6em;
            font-weight: 600;
            margin-bottom: 25px;
            color: #2c3e50;
        }

        .advanced-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .results-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 1.1em;
        }

        .results-table td {
            padding: 18px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .results-table tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.3s ease;
        }

        .snippet-cell {
            max-width: 500px;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.5;
            font-family: 'Consolas', 'Monaco', monospace;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 8px;
            padding: 12px;
        }

        .table-tag-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .table-tag {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .confidence-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .confidence-high { background: rgba(46, 204, 113, 0.2); }
        .confidence-medium { background: rgba(241, 196, 15, 0.2); }
        .confidence-low { background: rgba(231, 76, 60, 0.2); }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .algorithm-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .algorithm-details h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .algorithm-details ul {
            list-style: none;
            padding: 0;
        }

        .algorithm-details li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .algorithm-details li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: #3498db;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Pharmaceutical Classifier</h1>
            <p>Intelligent pharmaceutical domain classification with optimized performance</p>
            <div class="algorithm-info">
                <h3>Classification Engine</h3>
                <div class="algorithm-badges">
                    <span class="badge">Domain Intelligence</span>
                    <span class="badge">Entity Recognition</span>
                    <span class="badge">Semantic Matching</span>
                    <span class="badge">Context Analysis</span>
                    <span class="badge">Performance Optimized</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('single')">Single Snippet</button>
                    <button class="tab-button" onclick="switchTab('batch')">Batch Processing</button>
                </div>

                <!-- Single Snippet Tab -->
                <div id="singleTab" class="tab-content active">
                    <div class="input-section">
                        <label for="snippetInput">Enter Pharmaceutical Snippet:</label>
                        <textarea 
                            id="snippetInput" 
                            class="snippet-input" 
                            placeholder="Paste your pharmaceutical snippet here for intelligent classification..."
                        ></textarea>
                        <div class="controls">
                            <button id="classifyBtn" class="classify-btn" onclick="classifySnippet()">
                                🎯 Classify Snippet
                            </button>
                            <div class="threshold-control">
                                <label for="thresholdSlider">Confidence Threshold:</label>
                                <input type="range" id="thresholdSlider" class="threshold-slider" min="0.05" max="0.5" step="0.05" value="0.15">
                                <span id="thresholdValue">0.15</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Batch Processing Tab -->
                <div id="batchTab" class="tab-content">
                    <div class="input-section">
                        <label for="batchInput">Upload Multiple Snippets:</label>
                        <div class="batch-upload-area">
                            <h3>📄 Batch Snippet Processing</h3>
                            <p>Upload multiple pharmaceutical snippets for batch classification</p>
                            <textarea 
                                id="batchInput" 
                                class="batch-textarea" 
                                placeholder="Paste multiple snippets here, separated by empty lines or dashes (---).

Example:
Snippet 1: Novartis announced positive results for drug X...

---

Snippet 2: Pfizer's Q3 earnings showed strong performance...

---

Snippet 3: FDA approved new indication for Brand Y..."
                            ></textarea>
                            <div class="snippet-separator-info">
                                💡 Separate snippets with empty lines or "---" dividers
                            </div>
                        </div>
                        <div class="batch-controls">
                            <button id="batchProcessBtn" class="batch-process-btn" onclick="processBatchSnippets()">
                                🚀 Process All Snippets
                            </button>
                            <div class="threshold-control">
                                <label for="batchThresholdSlider">Confidence Threshold:</label>
                                <input type="range" id="batchThresholdSlider" class="threshold-slider" min="0.05" max="0.5" step="0.05" value="0.15">
                                <span id="batchThresholdValue">0.15</span>
                            </div>
                            <button id="downloadBtn" class="download-btn" onclick="downloadResults()" style="display: none;">
                                📥 Download CSV
                            </button>
                        </div>
                        <div id="batchProgress" class="batch-progress">
                            <div id="progressText">Processing snippets...</div>
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="processingInfo" class="processing-info" style="display: none;">
                <h4>Processing Pipeline</h4>
                <div class="processing-steps">
                    <div class="step" id="step1">Entity Extraction</div>
                    <div class="step" id="step2">Domain Analysis</div>
                    <div class="step" id="step3">Context Matching</div>
                    <div class="step" id="step4">Classification</div>
                    <div class="step" id="step5">Scoring</div>
                </div>
            </div>

            <div id="resultsSection" class="results-section" style="display: none;">
                <h2 class="results-title">Classification Results</h2>
                <div id="loadingDiv" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    Processing with pharmaceutical intelligence...
                </div>
                <div id="statsDiv" class="advanced-stats" style="display: none;">
                    <div class="stat-card">
                        <div id="tableCount" class="stat-number">0</div>
                        <div class="stat-label">Tables Identified</div>
                    </div>
                    <div class="stat-card">
                        <div id="avgConfidence" class="stat-number">0%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="stat-card">
                        <div id="processingTime" class="stat-number">0ms</div>
                        <div class="stat-label">Processing Time</div>
                    </div>
                    <div class="stat-card">
                        <div id="entityCount" class="stat-number">0</div>
                        <div class="stat-label">Entities Found</div>
                    </div>
                </div>
                <table id="resultsTable" class="results-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Input Snippet</th>
                            <th>Table Classification</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
                <div id="algorithmDetails" class="algorithm-details" style="display: none;">
                    <h4>Processing Details</h4>
                    <ul id="analysisDetails"></ul>
                </div>
            </div>

            <!-- Batch Results Section -->
            <div id="batchResultsSection" class="results-section" style="display: none;">
                <h2 class="results-title">📊 Batch Classification Results</h2>
                <div id="batchStatsDiv" class="advanced-stats" style="display: none;">
                    <div class="stat-card">
                        <div id="totalSnippets" class="stat-number">0</div>
                        <div class="stat-label">Snippets Processed</div>
                    </div>
                    <div class="stat-card">
                        <div id="totalClassifications" class="stat-number">0</div>
                        <div class="stat-label">Total Classifications</div>
                    </div>
                    <div class="stat-card">
                        <div id="batchAvgConfidence" class="stat-number">0%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="stat-card">
                        <div id="batchProcessingTime" class="stat-number">0s</div>
                        <div class="stat-label">Total Processing Time</div>
                    </div>
                </div>
                <table id="batchResultsTable" class="batch-results-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Snippet</th>
                            <th>Rationale for Classification</th>
                            <th>Table Tagged</th>
                        </tr>
                    </thead>
                    <tbody id="batchResultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Table Descriptions with pharmaceutical domain knowledge
        const tableDescriptions = {
            'geographies': {
                description: 'Captures hierarchical geographic data relevant to pharma, including sales regions, clinical sites, manufacturing facilities, and HQs.',
                keywords: ['geographic', 'location', 'region', 'country', 'site', 'facility', 'china', 'chinese', 'us', 'usa', 'europe', 'global', 'market', 'territory']
            },
            'organizations': {
                description: 'Contains records of pharma, biotech, and healthcare organizations including manufacturers, CROs, hospitals, academic institutions.',
                keywords: ['company', 'organization', 'pharmaceutical', 'biotech', 'manufacturer', 'corporation', 'inc', 'ltd', 'corp', '3sbio', 'novartis', 'pfizer']
            },
            'therapeutic_areas': {
                description: 'Comprehensive registry of medical therapeutic areas, providing standardized taxonomy for categorizing clinical specialties.',
                keywords: ['therapeutic area', 'medical specialty', 'clinical domain', 'consumer health', 'weight management', 'obesity', 'neuroscience', 'oncology']
            },
            'molecular_targets': {
                description: 'Captures molecular targets that pharmacological agents interact with to achieve therapeutic action.',
                keywords: ['molecular target', 'protein', 'enzyme', 'receptor', 'gene', 'pathway', 'mechanism', 'interaction', 'biological target']
            },
            'therapeutic_modalities': {
                description: 'Defines structural or technological classes of therapeutic agents used in pharmaceutical industry.',
                keywords: ['therapeutic modality', 'drug type', 'treatment class', 'pharmaceutical category', 'modality', 'platform', 'therapy']
            },
            'drug_classes': {
                description: 'Stores classifications used to group pharmaceutical drugs based on shared characteristics.',
                keywords: ['drug class', 'pharmaceutical classification', 'medication category', 'therapeutic class', 'weight loss drug', 'drug market']
            },
            'drugs': {
                description: 'Stores information about active pharmaceutical ingredients, drug compounds or biologics.',
                keywords: ['drug', 'medication', 'pharmaceutical', 'compound', 'active ingredient', 'semaglutide', 'therapeutic agent', 'medicine']
            },
            'preclinical_assets': {
                description: 'Represents preclinical R&D assets for drug candidates, tracking status and development stage.',
                keywords: ['preclinical', 'research', 'development', 'pipeline', 'candidate', 'discovery', 'early stage', 'investigational']
            },
            'brands': {
                description: 'Stores commercial or marketed brand names associated with pharmaceutical products.',
                keywords: ['brand', 'trademark', 'commercial name', 'marketed product', 'trade name', 'proprietary name']
            },
            'drug_combinations': {
                description: 'Identifies and tracks pharmaceutical agents containing multiple active ingredients.',
                keywords: ['combination', 'fixed dose', 'multi-drug', 'combined therapy', 'co-formulation', 'multiple ingredients']
            },
            'regimens': {
                description: 'Represents specific investigational treatment protocols involving sequences or combinations.',
                keywords: ['regimen', 'protocol', 'treatment schedule', 'dosing regimen', 'therapeutic protocol', 'treatment plan']
            },
            'diseases': {
                description: 'Stores information about medical conditions, illnesses, or disorders relevant to pharmaceutical research.',
                keywords: ['disease', 'condition', 'disorder', 'illness', 'pathology', 'medical condition', 'syndrome', 'obesity', 'overweight']
            },
            'indication_specifications': {
                description: 'Defines granular, context-specific patient populations or treatment settings for pharmaceutical interventions.',
                keywords: ['indication', 'patient population', 'treatment setting', 'clinical context', 'therapeutic indication', 'medical indication']
            },
            'standard_of_care': {
                description: 'Tracks recommended or established treatment approaches for specific disease indications.',
                keywords: ['standard of care', 'treatment guideline', 'established therapy', 'recommended treatment', 'clinical standard']
            },
            'drug_targets': {
                description: 'Establishes relationship between therapeutic entities and specific molecular targets.',
                keywords: ['drug target', 'molecular interaction', 'therapeutic target', 'mechanism of action', 'target engagement']
            },
            'drug_drug_classes': {
                description: 'Connects therapeutic entities to their relevant pharmacological or therapeutic classifications.',
                keywords: ['drug classification', 'therapeutic category', 'pharmacological class', 'medication group']
            },
            'drug_modalities': {
                description: 'Connects therapeutic entities to their technological or structural classification.',
                keywords: ['drug modality', 'therapeutic modality', 'treatment modality', 'pharmaceutical format']
            },
            'drug_combination_components': {
                description: 'Defines constituent active ingredients that make up combination products.',
                keywords: ['combination component', 'active ingredient', 'constituent', 'formulation component']
            },
            'regimen_components': {
                description: 'Details individual therapeutic agents that constitute specific treatment protocols.',
                keywords: ['regimen component', 'protocol element', 'treatment component', 'therapeutic element']
            },
            'preclinical_asset_indications': {
                description: 'Connects preclinical assets to specific disease indications they target.',
                keywords: ['preclinical indication', 'research target', 'development indication', 'investigational target']
            },
            'drug_indication_development_stages': {
                description: 'Tracks developmental progress or approval status of therapeutic assets for patient populations.',
                keywords: ['development stage', 'clinical phase', 'regulatory status', 'approval stage', 'development progress']
            },
            'organization_therapeutic_area_modalities': {
                description: 'Tracks organization strategic focus at intersection of therapeutic areas and modalities.',
                keywords: ['organizational focus', 'strategic area', 'therapeutic focus', 'business focus', 'development focus']
            },
            'entity_synonyms': {
                description: 'Manages variations in names, abbreviations, codes for entities within pharmaceutical domain.',
                keywords: ['synonym', 'alternative name', 'abbreviation', 'code', 'variant', 'nomenclature']
            },
            'clinical_trial_registries': {
                description: 'Provides reference information about major clinical trial registries.',
                keywords: ['trial registry', 'clinical registry', 'study registry', 'research registry']
            },
            'clinical_trials': {
                description: 'Stores detailed information about individual clinical studies designed to evaluate pharmaceutical interventions.',
                keywords: ['clinical trial', 'clinical study', 'research study', 'clinical research', 'human study', 'trial', 'study']
            },
            'clinical_trial_design': {
                description: 'Stores specific details about methodological design and structure of clinical studies.',
                keywords: ['trial design', 'study design', 'research methodology', 'clinical methodology', 'study structure']
            },
            'clinical_trial_arms': {
                description: 'Tracks distinct treatment cohorts within specific clinical studies.',
                keywords: ['trial arm', 'study arm', 'treatment group', 'cohort', 'study group']
            },
            'clinical_trial_arms_drugs': {
                description: 'Links specific therapeutic interventions to corresponding treatment groups within clinical studies.',
                keywords: ['trial intervention', 'study drug', 'treatment intervention', 'experimental drug']
            },
            'clinical_trial_arms_indications': {
                description: 'Connects treatment groups to precise disease indications being investigated.',
                keywords: ['trial indication', 'study indication', 'research indication', 'clinical indication']
            },
            'clinical_trial_sites': {
                description: 'Contains records of specific facilities where clinical trials are conducted.',
                keywords: ['clinical site', 'research site', 'trial site', 'study site', 'investigation site']
            },
            'clinical_data_points': {
                description: 'Stores quantitative or qualitative results reported from clinical trials.',
                keywords: ['clinical data', 'trial results', 'study data', 'clinical outcome', 'research results', 'endpoint']
            },
            'regulatory_authorities': {
                description: 'Reference table listing key global and regional regulatory agencies.',
                keywords: ['regulatory authority', 'regulatory agency', 'health authority', 'drug agency', 'approval agency']
            },
            'regulatory_application_types': {
                description: 'Reference table for various types of formal applications submitted to regulatory authorities.',
                keywords: ['regulatory application', 'submission type', 'filing type', 'regulatory filing', 'application type']
            },
            'regulatory_designation': {
                description: 'Tracks instances where pharmaceutical assets receive special regulatory status or designation.',
                keywords: ['regulatory designation', 'special status', 'regulatory pathway', 'expedited review', 'priority designation']
            },
            'regulatory_approvals': {
                description: 'Records specific instances of marketing authorization granted by regulatory agencies.',
                keywords: ['regulatory approval', 'marketing authorization', 'drug approval', 'product approval', 'license']
            },
            'regulatory_exclusivity': {
                description: 'Records periods of market exclusivity granted by regulatory authorities.',
                keywords: ['market exclusivity', 'regulatory exclusivity', 'patent protection', 'exclusivity period']
            },
            'regulatory_review_milestones': {
                description: 'Records key milestones, dates, and outcomes during formal regulatory review process.',
                keywords: ['regulatory milestone', 'review milestone', 'approval milestone', 'regulatory timeline', 'submission milestone']
            },
            'patents': {
                description: 'Stores detailed information about intellectual property patents relevant to pharmaceutical products.',
                keywords: ['patent', 'intellectual property', 'patent protection', 'patent rights', 'proprietary rights']
            },
            'patent_litigation': {
                description: 'Records legal disputes and challenges specifically related to pharmaceutical patents.',
                keywords: ['patent litigation', 'patent dispute', 'legal challenge', 'patent lawsuit', 'intellectual property dispute']
            },
            'drug_brand_packaging': {
                description: 'Stores packaging and formulation details for branded pharmaceutical products.',
                keywords: ['packaging', 'formulation', 'product packaging', 'drug packaging', 'pharmaceutical packaging']
            },
            'sales_data': {
                description: 'Captures sales and revenue data for pharmaceutical products and organizations.',
                keywords: ['sales', 'revenue', 'commercial performance', 'market performance', 'financial performance']
            },
            'market_sizing': {
                description: 'Stores aggregated market size estimates for disease indications within geographic regions.',
                keywords: ['market size', 'market opportunity', 'addressable market', 'market potential', 'market estimate', 'market overview', 'statistics', 'estimated number', 'million', 'billion', 'prevalence rate', 'patient population']
            },
            'market_forecasts': {
                description: 'Stores future market projections for pharmaceutical drugs, brands, or indications.',
                keywords: ['market forecast', 'market projection', 'future outlook', 'market prediction', 'commercial forecast', 'forecasts', 'increasing trend', 'estimated', 'bar chart', 'through 2030', 'denotes estimated']
            },
            'market_catalysts': {
                description: 'Tracks significant events expected to impact market dynamics within pharmaceutical industry.',
                keywords: ['market catalyst', 'market driver', 'commercial catalyst', 'market event', 'industry catalyst']
            },
            'organization_financial_data': {
                description: 'Stores key financial performance metrics reported by pharmaceutical organizations.',
                keywords: ['financial data', 'financial performance', 'financial metrics', 'earnings', 'financial results']
            },
            'business_deals': {
                description: 'Captures information on significant corporate transactions within pharmaceutical industry.',
                keywords: ['business deal', 'corporate transaction', 'merger', 'acquisition', 'partnership', 'collaboration']
            },
            'organization_development_roles': {
                description: 'Maps organizations to their specific roles in development or commercialization of pharmaceutical assets.',
                keywords: ['development role', 'organizational role', 'partnership role', 'collaboration role']
            },
            'investments': {
                description: 'Records financial investments made into pharmaceutical, biotech, or healthcare organizations.',
                keywords: ['investment', 'funding', 'capital', 'financing', 'venture capital', 'financial investment']
            },
            'transaction_assets': {
                description: 'Details specific assets that are part of business transactions.',
                keywords: ['transaction asset', 'deal asset', 'transferred asset', 'business asset']
            },
            'post_transaction_entity_changes': {
                description: 'Logs specific consequences of business deals on tracked entities.',
                keywords: ['entity change', 'transaction impact', 'organizational change', 'business impact']
            },
            'scientific_events': {
                description: 'Catalogs key scientific and medical conferences, symposia, and professional gatherings.',
                keywords: ['scientific event', 'medical conference', 'scientific conference', 'symposium', 'professional gathering']
            },
            'scientific_publications': {
                description: 'Stores metadata for scientific literature relevant to pharmaceutical domain.',
                keywords: ['scientific publication', 'research paper', 'journal article', 'scientific literature', 'research publication']
            },
            'entity_milestones': {
                description: 'Logs specific instances of significant events or achievements related to pharmaceutical entities.',
                keywords: ['milestone', 'achievement', 'significant event', 'key event', 'important milestone']
            },
            'document_sources': {
                description: 'Stores metadata about source documents from which information is extracted.',
                keywords: ['document source', 'source document', 'reference document', 'information source', 'presentation', 'corporate presentation']
            },
            'document_locations': {
                description: 'Identifies locations in source documents, capturing page/slide references.',
                keywords: ['document location', 'page reference', 'slide reference', 'document citation']
            },
            'field_citations': {
                description: 'Establishes precise traceability linking data fields to their exact origin in source documents.',
                keywords: ['field citation', 'data citation', 'source reference', 'traceability', 'data source']
            },
            'entity_versions': {
                description: 'Provides complete version history for each canonical pharmaceutical entity.',
                keywords: ['entity version', 'version history', 'entity change', 'historical record']
            },
            'schema_evolution': {
                description: 'Monitors and records structure of data attributes extracted for pharmaceutical entity types.',
                keywords: ['schema evolution', 'data structure', 'attribute structure', 'data schema']
            },
            'entity_resolution_log': {
                description: 'Records decisions linking extracted pharma entities to canonical database entries.',
                keywords: ['entity resolution', 'data linking', 'entity matching', 'data integration']
            },
            'data_source_metadata': {
                description: 'Stores essential metadata and characteristics for each registered data source.',
                keywords: ['data source', 'metadata', 'source characteristics', 'data characteristics']
            }
        };

        // Enhanced Pharmaceutical Classifier with domain intelligence
        class EnhancedPharmaceuticalClassifier {
            constructor() {
                this.threshold = 0.15;
                this.processingSteps = [];
                this.startTime = 0;
                this.entities = {};
            }

            // Dynamic pharmaceutical entity extraction using built-in knowledge
            extractPharmaceuticalEntities(text) {
                const entities = {
                    companies: [],
                    drugs: [],
                    brands: [],
                    therapeuticAreas: [],
                    diseases: [],
                    geographic: [],
                    marketTerms: [],
                    financialData: [],
                    presentationTerms: []
                };

                const words = this.tokenizeText(text);
                const textLower = text.toLowerCase();

                // Company detection using patterns and pharmaceutical knowledge
                this.detectCompanies(words, text, entities);

                // Drug detection using pharmaceutical naming patterns and knowledge
                this.detectDrugs(words, text, entities);

                // Brand detection using trademark patterns and pharmaceutical knowledge
                this.detectBrands(words, text, entities);

                // Therapeutic area detection using medical terminology
                this.detectTherapeuticAreas(words, text, entities);

                // Disease detection using medical conditions knowledge
                this.detectDiseases(words, text, entities);

                // Geographic detection using location patterns
                this.detectGeographic(words, text, entities);

                // Market terms detection
                this.detectMarketTerms(textLower, entities);

                // Financial data detection
                const financialMatches = text.match(/\d+\s*(million|billion|mn|bn|%)/gi);
                if (financialMatches) {
                    entities.financialData.push(...financialMatches);
                }

                // Presentation terms detection
                this.detectPresentationTerms(textLower, entities);

                return entities;
            }

            tokenizeText(text) {
                // Split into words while preserving pharmaceutical compounds
                return text.match(/\b[\w'-]+\b/g) || [];
            }

            detectCompanies(words, text, entities) {
                // Pattern-based company detection
                const companyPatterns = [
                    /\b\w+\s+(Inc|Ltd|Corp|Corporation|Company|Pharmaceutical|Pharma|Biotech|Therapeutics|Biosciences)\b/gi,
                    /\b\w+\s+&\s+\w+\b/gi, // Johnson & Johnson pattern
                    /\b[A-Z][a-z]+\s*[A-Z][a-z]*\s+(Inc|Ltd|Corp)\b/gi
                ];

                companyPatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            const company = match.replace(/\s+(Inc|Ltd|Corp|Corporation|Company|Pharmaceutical|Pharma|Biotech|Therapeutics|Biosciences)$/i, '').trim();
                            if (company.length > 2 && this.isLikelyPharmaceuticalCompany(company)) {
                                entities.companies.push(match.trim());
                            }
                        });
                    }
                });

                // Detect known pharmaceutical companies by name patterns
                words.forEach(word => {
                    if (this.isKnownPharmaceuticalCompany(word)) {
                        entities.companies.push(word);
                    }
                });
            }

            detectDrugs(words, text, entities) {
                // Drug suffix patterns based on pharmaceutical naming conventions
                const drugSuffixes = [
                    'mab', 'zumab', 'tuzumab', 'tinib', 'prazole', 'statin', 'cillin', 'mycin', 
                    'olol', 'pril', 'sartan', 'parib', 'afenib', 'ciclib', 'ceptor', 'glutide',
                    'formin', 'floxacin', 'thiazide', 'dipine', 'triptyline', 'azole', 'vir'
                ];

                // Check for drug suffixes
                words.forEach(word => {
                    const wordLower = word.toLowerCase();
                    drugSuffixes.forEach(suffix => {
                        if (wordLower.endsWith(suffix) && word.length > suffix.length + 2) {
                            if (this.isLikelyDrugName(word)) {
                                entities.drugs.push(word);
                            }
                        }
                    });
                });

                // Check for drugs in parentheses (common in pharmaceutical text)
                const parenthesesMatches = text.match(/\(([A-Z][a-z]+[a-z]{4,})\)/g);
                if (parenthesesMatches) {
                    parenthesesMatches.forEach(match => {
                        const drug = match.replace(/[()]/g, '');
                        if (this.isLikelyDrugName(drug)) {
                            entities.drugs.push(drug);
                        }
                    });
                }

                // Detect specific drug name patterns
                words.forEach(word => {
                    if (this.isKnownDrugName(word)) {
                        entities.drugs.push(word);
                    }
                });
            }

            detectBrands(words, text, entities) {
                // Brand patterns with trademark symbols
                const brandPatterns = [
                    /\b[A-Z][a-z]+[A-Z]*[a-z]*®/g,
                    /\b[A-Z][a-z]+[A-Z]*[a-z]*™/g,
                    /\b[A-Z][a-z]+[A-Z][a-z]+\b(?=\s*\([A-Z])/g // Brand followed by drug in parentheses
                ];

                brandPatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            const brand = match.replace(/[®™]/g, '');
                            if (brand.length > 3 && this.isLikelyPharmaceuticalBrand(brand)) {
                                entities.brands.push(match);
                            }
                        });
                    }
                });
            }

            detectTherapeuticAreas(words, text, entities) {
                const therapeuticAreaKeywords = [
                    'oncology', 'cardiology', 'neurology', 'neuroscience', 'immunology', 'respiratory',
                    'diabetes', 'nephrology', 'gastroenterology', 'dermatology', 'ophthalmology',
                    'psychiatry', 'hematology', 'endocrinology', 'infectious disease', 'rare disease',
                    'consumer health', 'weight management', 'metabolic', 'autoimmune', 'cardiovascular'
                ];

                therapeuticAreaKeywords.forEach(area => {
                    const regex = new RegExp(`\\b${area}\\b`, 'gi');
                    if (regex.test(text)) {
                        entities.therapeuticAreas.push(area);
                    }
                });
            }

            detectDiseases(words, text, entities) {
                // Disease pattern detection
                const diseasePatterns = [
                    /\b\w+\s+(disease|syndrome|disorder|condition)\b/gi,
                    /\b(cancer|tumor|carcinoma|sarcoma|lymphoma|leukemia)\b/gi,
                    /\b(diabetes|hypertension|arthritis|asthma|copd|alzheimer|parkinson)\b/gi,
                    /\b(obesity|overweight|depression|anxiety|migraine|epilepsy)\b/gi
                ];

                diseasePatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        entities.diseases.push(...matches);
                    }
                });
            }

            detectGeographic(words, text, entities) {
                const geographicPatterns = [
                    /\b(China|Chinese|US|USA|America|American|Europe|European|Japan|Japanese|Global|Worldwide|International)\b/gi,
                    /\b(Asia|African|Australian|Canadian|German|French|British|Italian|Spanish|Korean)\b/gi
                ];

                geographicPatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        entities.geographic.push(...matches);
                    }
                });
            }

            detectMarketTerms(textLower, entities) {
                const marketTerms = [
                    'market size', 'market forecast', 'forecast', 'estimated', 'statistics', 
                    'trend', 'opportunities', 'market share', 'revenue', 'sales'
                ];

                marketTerms.forEach(term => {
                    if (textLower.includes(term)) {
                        entities.marketTerms.push(term);
                    }
                });
            }

            detectPresentationTerms(textLower, entities) {
                const presentationTerms = [
                    'presentation', 'corporate presentation', 'slide', 'chart', 'title', 
                    'donut chart', 'bar chart', 'overview'
                ];

                presentationTerms.forEach(term => {
                    if (textLower.includes(term)) {
                        entities.presentationTerms.push(term);
                    }
                });
            }

            // Pharmaceutical knowledge validation functions
            isLikelyPharmaceuticalCompany(name) {
                const pharmaIndicators = ['bio', 'pharma', 'med', 'therapeutic', 'sciences', 'labs'];
                const nameLower = name.toLowerCase();
                
                // Check if name contains pharmaceutical indicators
                for (const indicator of pharmaIndicators) {
                    if (nameLower.includes(indicator)) return true;
                }
                
                // Check if it's a known major pharmaceutical company
                return this.isKnownPharmaceuticalCompany(name);
            }

            isKnownPharmaceuticalCompany(name) {
                // Use pharmaceutical knowledge to identify known companies
                const knownCompanies = {
                    'novartis': true, 'pfizer': true, 'roche': true, 'merck': true, 'gsk': true,
                    'glaxosmithkline': true, 'johnson': true, 'abbvie': true, 'bristol': true,
                    'lilly': true, 'sanofi': true, 'bayer': true, 'takeda': true, 'astrazeneca': true,
                    'gilead': true, 'biogen': true, 'amgen': true, 'regeneron': true, 'vertex': true,
                    'moderna': true, 'biontech': true, '3sbio': true, 'celgene': true, 'allergan': true
                };
                return knownCompanies[name.toLowerCase()] || false;
            }

            isLikelyDrugName(name) {
                // Basic validation for drug names
                if (name.length < 4) return false;
                if (!/^[A-Za-z]/.test(name)) return false;
                
                // Exclude common English words that might match patterns
                const commonWords = ['presentation', 'company', 'development', 'treatment', 'management'];
                return !commonWords.includes(name.toLowerCase());
            }

            isKnownDrugName(name) {
                // Use pharmaceutical knowledge for known drugs
                const knownDrugs = {
                    'semaglutide': true, 'ozempic': true, 'wegovy': true, 'mounjaro': true,
                    'trulicity': true, 'iptacopan': true, 'aspirin': true, 'metformin': true,
                    'insulin': true, 'adalimumab': true, 'bevacizumab': true, 'trastuzumab': true,
                    'pembrolizumab': true, 'nivolumab': true, 'rituximab': true, 'infliximab': true
                };
                return knownDrugs[name.toLowerCase()] || false;
            }

            isLikelyPharmaceuticalBrand(name) {
                // Check if it follows pharmaceutical brand naming patterns
                if (name.length < 3) return false;
                
                // Pharmaceutical brands often have specific patterns
                const hasCapitalPattern = /^[A-Z][a-z]+[A-Z]?[a-z]*$/.test(name);
                const isNotCommonWord = !['Title', 'Main', 'Chart', 'Data'].includes(name);
                
                return hasCapitalPattern && isNotCommonWord;
            }

            // Enhanced classification with rationale generation
            classify(snippet) {
                this.startTime = Date.now();
                this.processingSteps = [];
                
                // Step 1: Entity Extraction
                this.updateProcessingStep('step1', 'active');
                this.entities = this.extractPharmaceuticalEntities(snippet);
                this.processingSteps.push(`Extracted entities: ${Object.keys(this.entities).filter(k => this.entities[k].length > 0).join(', ')}`);
                this.updateProcessingStep('step1', 'completed');

                // Step 2: Domain Analysis
                this.updateProcessingStep('step2', 'active');
                const snippetLower = snippet.toLowerCase();
                this.processingSteps.push('Analyzed pharmaceutical domain context');
                this.updateProcessingStep('step2', 'completed');

                // Step 3: Context Matching
                this.updateProcessingStep('step3', 'active');
                this.processingSteps.push('Matched entities to table contexts');
                this.updateProcessingStep('step3', 'completed');

                // Step 4: Classification
                this.updateProcessingStep('step4', 'active');
                const classifications = [];

                for (const [tableName, tableInfo] of Object.entries(tableDescriptions)) {
                    let score = 0;
                    let matches = [];
                    let rationale = [];

                    // Keyword matching
                    for (const keyword of tableInfo.keywords) {
                        if (snippetLower.includes(keyword.toLowerCase())) {
                            score += 0.3;
                            matches.push(`Keyword: ${keyword}`);
                            rationale.push(`Found keyword "${keyword}" which indicates ${tableName} relevance`);
                        }
                    }

                    // Entity-specific boosts with detailed rationales
                    const entityRationale = this.generateEntityRationale(tableName, snippet, rationale);
                    score += entityRationale.score;
                    matches.push(...entityRationale.matches);

                    if (score > this.threshold) {
                        classifications.push({
                            table: tableName,
                            confidence: Math.min(score, 1.0),
                            matches: matches,
                            rationale: rationale.length > 0 ? rationale.join('. ') : `Content matches ${tableName} classification criteria based on keyword and context analysis`,
                            breakdown: {
                                score: score,
                                matchCount: matches.length
                            }
                        });
                    }
                }

                this.processingSteps.push(`Generated ${classifications.length} classifications`);
                this.updateProcessingStep('step4', 'completed');

                // Step 5: Scoring
                this.updateProcessingStep('step5', 'active');
                classifications.sort((a, b) => b.confidence - a.confidence);

                // Always include document tables with rationales
                if (!classifications.some(c => c.table === 'document_sources')) {
                    classifications.push({
                        table: 'document_sources',
                        confidence: 0.8,
                        matches: ['Default: All snippets have document sources'],
                        rationale: 'All pharmaceutical content originates from source documents and requires document metadata tracking for traceability and compliance purposes',
                        breakdown: { score: 0.8, matchCount: 1 }
                    });
                }

                if (!classifications.some(c => c.table === 'field_citations')) {
                    classifications.push({
                        table: 'field_citations',
                        confidence: 0.8,
                        matches: ['Default: All snippets need field citations'],
                        rationale: 'Pharmaceutical data requires precise traceability linking specific information back to its exact source location for regulatory compliance and data integrity',
                        breakdown: { score: 0.8, matchCount: 1 }
                    });
                }

                this.processingSteps.push('Final scoring and ranking completed');
                this.updateProcessingStep('step5', 'completed');

                return classifications;
            }

            // Generate detailed rationales for entity-based classifications
            generateEntityRationale(tableName, snippet, rationale) {
                let score = 0;
                let matches = [];

                switch (tableName) {
                    case 'organizations':
                        if (this.entities.companies.length > 0) {
                            score += 0.6;
                            matches.push(`Companies: ${this.entities.companies.join(', ')}`);
                            rationale.push(`Identified pharmaceutical organizations: ${this.entities.companies.join(', ')}. This content contains information about pharmaceutical companies and should be stored in the organizations table`);
                        }
                        break;
                    case 'drugs':
                        if (this.entities.drugs.length > 0) {
                            score += 0.6;
                            matches.push(`Drugs: ${this.entities.drugs.join(', ')}`);
                            rationale.push(`Detected pharmaceutical drugs: ${this.entities.drugs.join(', ')}. This content discusses specific drug compounds/medications and belongs in the drugs table`);
                        }
                        break;
                    case 'therapeutic_areas':
                        if (this.entities.therapeuticAreas.length > 0) {
                            score += 0.6;
                            matches.push(`Therapeutic Areas: ${this.entities.therapeuticAreas.join(', ')}`);
                            rationale.push(`Found therapeutic areas: ${this.entities.therapeuticAreas.join(', ')}. This content relates to medical specialties and treatment domains relevant to the therapeutic_areas table`);
                        }
                        break;
                    case 'diseases':
                        if (this.entities.diseases.length > 0) {
                            score += 0.6;
                            matches.push(`Diseases: ${this.entities.diseases.join(', ')}`);
                            rationale.push(`Identified medical conditions: ${this.entities.diseases.join(', ')}. This content discusses specific diseases/conditions and should be categorized under the diseases table`);
                        }
                        break;
                    case 'geographies':
                        if (this.entities.geographic.length > 0) {
                            score += 0.6;
                            matches.push(`Geographic: ${this.entities.geographic.join(', ')}`);
                            rationale.push(`Detected geographic references: ${this.entities.geographic.join(', ')}. This content has geographic context and belongs in the geographies table`);
                        }
                        break;
                    case 'market_sizing':
                        if (this.entities.marketTerms.length > 0 || this.entities.financialData.length > 0) {
                            score += 0.6;
                            matches.push(`Market indicators found`);
                            rationale.push(`Contains market sizing indicators including statistical data and patient population estimates. This content provides market size estimates and belongs in the market_sizing table`);
                        }
                        if (snippet.toLowerCase().includes('market size') || snippet.toLowerCase().includes('statistics')) {
                            score += 0.4;
                            matches.push('Market sizing language detected');
                            rationale.push(`Explicit market sizing language detected. This content directly discusses market size estimates or statistical data relevant to pharmaceutical markets`);
                        }
                        break;
                    case 'market_forecasts':
                        if (snippet.toLowerCase().includes('forecast') || snippet.toLowerCase().includes('trend')) {
                            score += 0.7;
                            matches.push('Forecast language detected');
                            rationale.push(`Contains forecasting language indicating future market projections. This content provides market predictions and belongs in the market_forecasts table`);
                        }
                        if (snippet.toLowerCase().includes('2030e') || snippet.toLowerCase().includes('estimated')) {
                            score += 0.5;
                            matches.push('Future projections detected');
                            rationale.push(`Detected future projections with estimated data points. This content includes forward-looking market predictions suitable for the market_forecasts table`);
                        }
                        break;
                    case 'document_sources':
                        if (this.entities.presentationTerms.length > 0) {
                            score += 0.6;
                            matches.push(`Document terms: ${this.entities.presentationTerms.join(', ')}`);
                            rationale.push(`Contains document-related terminology: ${this.entities.presentationTerms.join(', ')}. This content references source materials and belongs in the document_sources table`);
                        }
                        break;
                }

                return { score, matches };
            }

            updateProcessingStep(stepId, status) {
                const step = document.getElementById(stepId);
                if (step) {
                    step.className = 'step ' + status;
                }
            }

            getProcessingTime() {
                return Date.now() - this.startTime;
            }

            getAnalysisDetails() {
                return this.processingSteps;
            }

            getEntityCount() {
                return Object.values(this.entities).reduce((sum, arr) => sum + arr.length, 0);
            }
        }

        // Initialize classifier
        const classifier = new EnhancedPharmaceuticalClassifier();

        // Update threshold display
        document.getElementById('thresholdSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('thresholdValue').textContent = value;
            classifier.threshold = parseFloat(value);
        });

        // Update batch threshold display
        document.getElementById('batchThresholdSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('batchThresholdValue').textContent = value;
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'single') {
                document.getElementById('singleTab').classList.add('active');
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('batchResultsSection').style.display = 'none';
            } else if (tabName === 'batch') {
                document.getElementById('batchTab').classList.add('active');
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('batchResultsSection').style.display = 'block';
            }
        }

        // Batch processing functionality
        let batchResults = [];

        async function processBatchSnippets() {
            const batchInput = document.getElementById('batchInput').value.trim();
            if (!batchInput) {
                alert('Please enter snippets to process.');
                return;
            }

            // Parse snippets (split by empty lines or ---)
            const snippets = batchInput
                .split(/\n\s*\n|\n\s*---\s*\n/)
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (snippets.length === 0) {
                alert('No valid snippets found. Please separate snippets with empty lines or "---".');
                return;
            }

            // Setup processing
            const batchThreshold = parseFloat(document.getElementById('batchThresholdSlider').value);
            classifier.threshold = batchThreshold;
            
            document.getElementById('batchProcessBtn').disabled = true;
            document.getElementById('batchProgress').style.display = 'block';
            document.getElementById('batchResultsSection').style.display = 'block';
            
            const startTime = Date.now();
            batchResults = [];
            let totalClassifications = 0;
            let totalConfidence = 0;

            // Process each snippet
            for (let i = 0; i < snippets.length; i++) {
                const snippet = snippets[i];
                
                // Update progress
                const progress = ((i + 1) / snippets.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Processing snippet ${i + 1} of ${snippets.length}...`;
                
                // Add delay for better UX
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Classify snippet
                const classifications = classifier.classify(snippet);
                totalClassifications += classifications.length;
                
                // Add results with rationales
                classifications.forEach(classification => {
                    totalConfidence += classification.confidence;
                    batchResults.push({
                        snippet: snippet,
                        rationale: classification.rationale,
                        table: classification.table,
                        confidence: classification.confidence
                    });
                });
            }

            // Update final stats
            const processingTime = (Date.now() - startTime) / 1000;
            const avgConfidence = totalClassifications > 0 ? totalConfidence / totalClassifications : 0;
            
            document.getElementById('totalSnippets').textContent = snippets.length;
            document.getElementById('totalClassifications').textContent = totalClassifications;
            document.getElementById('batchAvgConfidence').textContent = Math.round(avgConfidence * 100) + '%';
            document.getElementById('batchProcessingTime').textContent = processingTime.toFixed(1) + 's';

            // Display results
            displayBatchResults();
            
            // Show stats and download button
            document.getElementById('batchStatsDiv').style.display = 'grid';
            document.getElementById('downloadBtn').style.display = 'inline-block';
            
            // Hide progress
            document.getElementById('batchProgress').style.display = 'none';
            document.getElementById('batchProcessBtn').disabled = false;
        }

        function displayBatchResults() {
            const resultsBody = document.getElementById('batchResultsBody');
            resultsBody.innerHTML = '';

            batchResults.forEach((result) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="batch-snippet-cell">${result.snippet}</td>
                    <td class="rationale-cell">${result.rationale}</td>
                    <td class="table-tag-cell">
                        <span class="batch-table-tag">
                            ${result.table} (${Math.round(result.confidence * 100)}%)
                        </span>
                    </td>
                `;
                resultsBody.appendChild(row);
            });

            document.getElementById('batchResultsTable').style.display = 'table';
        }

        function downloadResults() {
            if (batchResults.length === 0) {
                alert('No results to download.');
                return;
            }

            // Create CSV content
            const csvHeader = 'Snippet,Rationale for Classification,Table Tagged,Confidence\n';
            const csvContent = batchResults.map(result => {
                const snippet = result.snippet.replace(/"/g, '""');
                const rationale = result.rationale.replace(/"/g, '""');
                const table = result.table;
                const confidence = Math.round(result.confidence * 100) + '%';
                return `"${snippet}","${rationale}","${table}","${confidence}"`;
            }).join('\n');

            const fullCsv = csvHeader + csvContent;

            // Create and download file
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pharmaceutical_classifications_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function classifySnippet() {
            const snippet = document.getElementById('snippetInput').value.trim();
            if (!snippet) {
                alert('Please enter a snippet to classify.');
                return;
            }

            // Show processing UI
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('processingInfo').style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsTable').style.display = 'none';
            document.getElementById('statsDiv').style.display = 'none';
            document.getElementById('algorithmDetails').style.display = 'none';
            document.getElementById('classifyBtn').disabled = true;

            // Reset processing steps
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(id => {
                document.getElementById(id).className = 'step';
            });

            // Add processing delay for better UX
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Perform classification
            const classifications = classifier.classify(snippet);
            const processingTime = classifier.getProcessingTime();

            // Display results
            displayResults(snippet, classifications, processingTime);

            // Show results UI
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultsTable').style.display = 'table';
            document.getElementById('statsDiv').style.display = 'grid';
            document.getElementById('algorithmDetails').style.display = 'block';
            document.getElementById('classifyBtn').disabled = false;
        }

        function displayResults(snippet, classifications, processingTime) {
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';

            classifications.forEach((classification, index) => {
                const row = document.createElement('tr');
                const confidenceClass = classification.confidence > 0.7 ? 'confidence-high' : 
                                      classification.confidence > 0.4 ? 'confidence-medium' : 'confidence-low';
                
                const matchesText = classification.matches && classification.matches.length > 0 ? 
                    classification.matches.slice(0, 2).join('; ') : 
                    'Pattern-based match';

                const rationaleText = classification.rationale || 'Classification based on keyword and pattern analysis';

                row.innerHTML = `
                    <td class="snippet-cell">${index === 0 ? snippet : ''}</td>
                    <td class="table-tag-container">
                        <span class="table-tag">
                            ${classification.table}
                            <span class="confidence-score ${confidenceClass}">
                                ${Math.round(classification.confidence * 100)}%
                            </span>
                        </span>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px; font-style: italic;">
                            ${matchesText}
                        </div>
                        <div style="font-size: 0.85em; color: #555; margin-top: 8px; padding: 8px; background: rgba(52, 152, 219, 0.05); border-radius: 4px;">
                            <strong>Rationale:</strong> ${rationaleText}
                        </div>
                    </td>
                `;
                resultsBody.appendChild(row);
            });

            // Update statistics
            const avgConfidence = classifications.reduce((sum, c) => sum + c.confidence, 0) / classifications.length;
            const entityCount = classifier.getEntityCount();
            
            document.getElementById('tableCount').textContent = classifications.length;
            document.getElementById('avgConfidence').textContent = Math.round(avgConfidence * 100) + '%';
            document.getElementById('processingTime').textContent = processingTime + 'ms';
            document.getElementById('entityCount').textContent = entityCount;

            // Show algorithm details
            const analysisDetails = document.getElementById('analysisDetails');
            analysisDetails.innerHTML = '';
            classifier.getAnalysisDetails().forEach(detail => {
                const li = document.createElement('li');
                li.textContent = detail;
                analysisDetails.appendChild(li);
            });
        }

        // Keyboard shortcuts
        document.getElementById('snippetInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                classifySnippet();
            }
        });

        // Initialize threshold displays
        document.getElementById('thresholdValue').textContent = '0.15';
        document.getElementById('batchThresholdValue').textContent = '0.15';
    </script>
</body>
</html>
